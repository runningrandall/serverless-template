name: Deploy

on:
  pull_request:
    branches:
      - "main"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Install Dependencies
        run: pnpm install

      - name: Run Unit Tests
        run: pnpm test

      - name: Run Linting
        run: pnpm --filter frontend lint

      - name: Deploy Infrastructure
        run: pnpm --filter infra run deploy --require-approval never

      - name: Build and Deploy Frontend
        run: |
          # Determine STAGE_NAME (Logic must match bin/infra.ts)
          if [ -n "${{ github.head_ref }}" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          # Sanitize: clean alphanumeric
          STAGE_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9]//g')
          
          # Determine API Stack Name
          INFRA_STACK_NAME="HmaasInfraStack-$STAGE_NAME"
          FRONTEND_STACK_NAME="HmaasFrontendStack"
          
          echo "Determined Stage: $STAGE_NAME"
          echo "Infra Stack: $INFRA_STACK_NAME"
          echo "Frontend Stack: $FRONTEND_STACK_NAME"

          # Get API URL from Infra Stack
          API_URL=$(aws cloudformation describe-stacks --stack-name $INFRA_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" --output text)
          export NEXT_PUBLIC_API_URL=$API_URL
          echo "Found API_URL: $API_URL"

          # Determine Bucket and Base Path
          if [ "$BRANCH_NAME" == "main" ]; then
             echo "Deploying to PROD"
             BUCKET_NAME=$(aws cloudformation describe-stacks --stack-name $FRONTEND_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='ProdBucketName'].OutputValue" --output text)
             DISTRO_ID=$(aws cloudformation describe-stacks --stack-name $FRONTEND_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='ProdDistributionId'].OutputValue" --output text)
             export NEXT_PUBLIC_BASE_PATH=""
             S3_DEST="s3://${BUCKET_NAME}"
          else
             echo "Deploying to NON-PROD"
             BUCKET_NAME=$(aws cloudformation describe-stacks --stack-name $FRONTEND_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='NonProdBucketName'].OutputValue" --output text)
             DISTRO_ID=$(aws cloudformation describe-stacks --stack-name $FRONTEND_STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='NonProdDistributionId'].OutputValue" --output text)
             # Use original branch name for path, but maybe sanitized? 
             # Next.js basePath requires leading slash.
             # We should probably use original branch name if safe, or the sanitized one?
             # Let's use the sanitized STAGE_NAME to match the ephemeral stack ID concept.
             export NEXT_PUBLIC_BASE_PATH="/${STAGE_NAME}" 
             S3_DEST="s3://${BUCKET_NAME}/${STAGE_NAME}"
          fi
          
          echo "Building with BASE_PATH: $NEXT_PUBLIC_BASE_PATH"
          pnpm --filter frontend run build

          echo "Deploying to: $S3_DEST"
          aws s3 sync frontend/out "$S3_DEST" --delete
          
          # Invalidate CloudFront (optional but recommended)
          if [ -n "$DISTRO_ID" ]; then
             echo "Invalidating CloudFront Distribution: $DISTRO_ID"
             aws cloudfront create-invalidation --distribution-id "$DISTRO_ID" --paths "/*"
          fi
